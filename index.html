
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>masarakki's blog</title>
  <meta name="author" content="masarakki">

  
  <meta name="description" content="キチガイRubyistの技術ブログ">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://masarakki.github.com">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/bootstrap/bootstrap.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/bootstrap/responsive.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/syntax/syntax.css" media="screen, projection" rel="stylesheet" type="text/css">
  <style type="text/css">
    body {
      padding-bottom: 40px;
    }
    h1 {
      margin-bottom: 15px;
    }
    img {
      max-width: 100%;
    }
    .sharing, .meta, .pager {
      margin: 20px 0px 20px 0px;
    }
    .page-footer p {
      text-align: center;
    }
  </style>
  <script src="/javascripts/libs/jquery.js"></script>
  <script src="/javascripts/libs/modernizr-2.0.js"></script>
  <script src="/javascripts/libs/bootstrap.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="masarakki's blog" type="application/atom+xml">
  
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-20908831-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <nav role="navigation"><div class="navbar">
  <div class="navbar-inner">
    <div class="container">
      <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </a>

      <a class="brand" href="/">masarakki's blog</a>

      <div class="nav-collapse">
        <ul class="nav">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/resume">Resume</a></li>
</ul>


        <ul class="nav pull-right" data-subscription="rss">
          <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
          
        </ul>

        
          <form class="pull-right navbar-search" action="http://google.com/search" method="get">
            <fieldset role="search">
              <input type="hidden" name="q" value="site:masarakki.github.com" />
              <input class="search-query" type="text" name="q" results="0" placeholder="Search"/>
            </fieldset>
          </form>
        
      </div>
    </div>
  </div>
</div>
</nav>
  <div class="container">
    <div class="row-fluid">
      <div class="span9">
  
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/blog/2013/03/22/java-ja-kowai/">Java-ja Kowai</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-03-22T22:16:00+09:00" pubdate data-updated="true">Mar 22<span>nd</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>java-ja.DDD 行ってきました</h1>

<p><strong>java-ja 怖い</strong></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/blog/2013/03/16/make-url-cool/">Make Url Cool</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-03-16T17:53:00+09:00" pubdate data-updated="true">Mar 16<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>Railsでurlをカッコ良くする</h2>

<p>railsで普通にこんな感じに config/route.rb を書くと、</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">resources</span> <span class="ss">:genres</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">resources</span> <span class="ss">:books</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>urlはこんな感じになります。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="sr">/genres/</span><span class="mi">1</span><span class="o">/</span><span class="n">books</span>
</span></code></pre></td></tr></table></div></figure>


<p>1ってなんだよ! 1って!!</p>

<h2>urlにidじゃないものをつかう</h2>

<p>ジャンルのようなある程度数が決まっていて名前も変化しなさそうなのは、</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="sr">/genres/</span><span class="n">comic</span><span class="o">/</span><span class="n">books</span>
</span></code></pre></td></tr></table></div></figure>


<p>みたいなurlにできるとカッコイイですよね。</p>

<p>genre_books_path(genre) のメソッドで、genre.idではなくgenre.nameにできれば上手くいきそうです。
このメソッドを調べると(追っていくのメチャメチャ難しかった)、
どうやら to_param というメソッドを経由して id が呼ばれていました。
このto_paramを書き換えてnameを返すようにしてしまっていいのでしょうか?</p>

<p>そこで <a href="http://api.rubyonrails.org">http://api.rubyonrails.org</a> でto_paramを探すと、「ActionPackでurlを作るときに使うよ!」と、
しかもまさにやりたいことそのままのサンプルコードが置いてありました。</p>

<p>というわけで <strong>to_param を書き換えてしまえばid以外にも自由にurlを作れる</strong> ことがわかりました。</p>

<h2>to_param って・・・</h2>

<p>url作るキーを取得するメソッドが to_param ってそんなの検索できねーよ・・・
名付けがクソだと人生の貴重な時間を無駄にするという例でした。</p>

<h2>本当にやりたいこと</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="sr">/comics</span>
</span><span class='line'><span class="sr"> /no</span><span class="n">vels</span>
</span></code></pre></td></tr></table></div></figure>


<p>みたいなurlにしたい。 resourcesをきちんと使って。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/blog/2013/02/14/supervisor-with-rvm/">Run Ruby on Supervisor With RVM</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-02-14T16:17:00+09:00" pubdate data-updated="true">Feb 14<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>supervisorとは</h2>

<p>supervisorとは、pythonで書かれたプロセス監視ツールです。
簡単にインストールでき、デーモンとして動作し、
マシンブート時に任意のプログラムを立ち上げたり、そのプロセスが死んだ時に自動再起動などができます。</p>

<p>動かすプログラムは、単純な無限ループするようなコードでよく、
プロセス永続化などの面倒な仕事は全部supervisorに任せてしまえます。</p>

<h2>RVMで使う時の問題点</h2>

<p>RVMは個人環境にrubyをインストールし、実行するためには環境変数の整備などが必要で、
通常はシェルの起動時に設定スクリプトを読み込んで上手いことやってくれます。
ですが、supervisorを使う場合その方法が取れないのでなんとかしないといけません。</p>

<p>supervisorはenvironmentで環境変数を設定できるのですが、</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ rvm env</span></code></pre></td></tr></table></div></figure>


<p>で出力した環境変数を使っても上手くいきませんでした。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>command=which bundle</span></code></pre></td></tr></table></div></figure>


<p>は想定したpathを返すのですが、</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>command=bundle exec ...</span></code></pre></td></tr></table></div></figure>


<p>にすると bundle not found. と・・・</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>command=cd /path/to/project ; bundle exec ...</span></code></pre></td></tr></table></div></figure>


<p>にしてみても、上手いこと解釈してくれないし、そもそもcdを見つけてくれません。 (シェル組み込みコマンドだから?)</p>

<p>もう意味わかりません。</p>

<h2>そう言えば昔wrapperってあったよね</h2>

<p>そういえば昔まだbundlerがなくてpassengerが主流だったときは、
rvm wrapper とかいうのやってそれを使えって書いてあるサイトが多かったと思います。
なんかマルっと環境を上手いことやってくれるものだっていう認識でした。
試してみましょう。</p>

<p>なんか適当に名前を付けてwrapperを作ります。
gemsetも一緒に hoge_task とかの名前にします。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ rvm wrapper 1.9.3-p385@hoge_task hoge_task bundle</span></code></pre></td></tr></table></div></figure>


<p>これで $HOME/.rvm/bin に hoge_task_bundle というコマンドができあがりました。
実際にフルパスでこのコマンドを叩くと hoge_task のgemsetを使ってbundleが動いているのがわかります。
supervisorのcommandの設定にこれを使えば良さそうです。</p>

<p>supervisorの設定ファイルは全体でこんな感じです</p>

<h3>/etc/supervisor/conf.d/hoge_task.conf</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[program:hoge_task]
</span><span class='line'>command=/home/{USERNAME}/.rvm/bin/hoge_task_bundle exec rackup -p 8000
</span><span class='line'>autostart=true
</span><span class='line'>autorestart=true
</span><span class='line'>stopsignal=QUIT
</span><span class='line'>stdout_logfile=/var/log/hoge_task/out.log
</span><span class='line'>stderr_logfile=/var/log/hoge_task/err.log
</span><span class='line'>user={USERNAME}
</span><span class='line'>diretory=/home/{USERNAME}/projects/hoge_task</span></code></pre></td></tr></table></div></figure>


<p>あとは</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo supervisorctl reload
</span><span class='line'>$ sudo supervisorctl status</span></code></pre></td></tr></table></div></figure>


<p>とかやって設定を読み込み直し、結果を見てみましょう。
多分うまく動き出してるはずですよ!</p>

<h2>Gemfileやruby自体の更新</h2>

<p>プログラムを変更してGemfileが変わった時や、
rubyのバージョンアップをした時などはどうなるのでしょうか?</p>

<p>これもGemfileのアップデートなら</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ bundle install</span></code></pre></td></tr></table></div></figure>


<p>で、いつもどおりgemをインストールした後、(もちろん @hoge_task のgemsetを使って!)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo supervisorctl restart hoge_task</span></code></pre></td></tr></table></div></figure>


<p>でプロセスを再起動すればいいはずです。</p>

<p>rubyを更新した場合は、新しいバージョンを指定してrvm wrapperを作りなおせば、
hoge_task_bundle の中身が書き換えられるので、supervisorの設定はそのままで大丈夫です。
あとは上と同様に bundle install してプロセスの再起動を指示します。</p>

<h2>もう何も怖くない</h2>

<p>これはsupervisorの設定と言うよりむしろ、
ユーザ環境にインストールされたrvmをシステムに近いところで使う汎用的な方法のようです。
自動でrackアプリを起動したり、バックグラウンドでタスクを回したり、いろいろできるようになりました。</p>

<p>というわけで仕事で使うメモでした。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/blog/2012/11/04/how-to-travis-a-gem-with-c-extension/">Travis CIでrubyのC拡張が入ったgemのテストをする方法</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-11-04T17:11:00+09:00" pubdate data-updated="true">Nov 4<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>No Such File</h2>

<p>C拡張が含まれたgemをそのままTravisに流してみると、</p>

<pre><code>$ bundle exec rake
56/home/vagrant/.rvm/rubies/ruby-1.8.7-p358/bin/ruby -S rspec spec/jpeg_spec.rb
57/home/vagrant/builds/masarakki/jpeg/spec/../lib/jpeg.rb:2:
  in `require': no such file to load -- jpeg.so (LoadError)
</code></pre>

<p>自分でコンパイルしないといけないみたいですね。</p>

<h2>とりあえずやってみた</h2>

<p>試しに.travis.ymlでコンパイルの命令を追加してみました。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">before_script</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">cd ext ; ruby extconf.rb ; make install</span>
</span></code></pre></td></tr></table></div></figure>


<p>やった! Travisがテスト全部通したよ!!!</p>

<p>Travisの実行ログを見てみると、</p>

<pre><code>55$ cd ext ; ruby extconf.rb ; make install
56checking for jpeglib.h... yes
57checking for main() in -ljpeg... yes
58creating Makefile
59gcc -I. -I. -I/home/vagrant/.rvm/rubies/ruby-1.8.7-p358/lib/ruby/1.8/i686-linux -I. -DHAVE_JPEGLIB_H  -D_FILE_OFFSET_BITS=64  -fPIC -g -O2  -fPIC   -c jpeg.c
60gcc -I. -I. -I/home/vagrant/.rvm/rubies/ruby-1.8.7-p358/lib/ruby/1.8/i686-linux -I. -DHAVE_JPEGLIB_H  -D_FILE_OFFSET_BITS=64  -fPIC -g -O2  -fPIC   -c jpeg_error.c
61gcc -I. -I. -I/home/vagrant/.rvm/rubies/ruby-1.8.7-p358/lib/ruby/1.8/i686-linux -I. -DHAVE_JPEGLIB_H  -D_FILE_OFFSET_BITS=64  -fPIC -g -O2  -fPIC   -c jpeg_jpeg.c
62gcc -shared -o jpeg.so jpeg.o jpeg_error.o jpeg_jpeg.o -L. -L/home/vagrant/.rvm/rubies/ruby-1.8.7-p358/lib -Wl,-R/home/vagrant/.rvm/rubies/ruby-1.8.7-p358/lib -L.  -rdynamic -Wl,-export-dynamic    -Wl,-R -Wl,/home/vagrant/.rvm/rubies/ruby-1.8.7-p358/lib -L/home/vagrant/.rvm/rubies/ruby-1.8.7-p358/lib -lruby -ljpeg  -lrt -ldl -lcrypt -lm   -lc
63/usr/bin/install -c -m 0755 jpeg.so /home/vagrant/.rvm/rubies/ruby-1.8.7-p358/lib/ruby/site_ruby/1.8/i686-linux



    ＿人人人人人人人人人＿
    ＞　site_ruby の下　＜
    ￣^Y^Y^Y^Y^Y^Y^Y^￣
</code></pre>

<p>これはダメですねヤバイですねやっちゃダメですね。</p>

<h2>rake-compiler を使う</h2>

<p><a href="https://github.com/luislavena/rake-compiler">rake-compiler</a> というgemを使うと上手いことやってくれるようです。</p>

<h4>gem追加</h4>

<p>Gemfileに以下を追加</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">gem</span> <span class="s1">&#39;rake-compiler&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>んで</p>

<pre><code>$ bundle install
</code></pre>

<h4>タスク追加</h4>

<p>Rakefileに以下を追加</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">if</span> <span class="no">RUBY_PLATFORM</span> <span class="o">=~</span> <span class="sr">/java/</span>
</span><span class='line'>  <span class="nb">require</span> <span class="s1">&#39;rake/javaextensiontask&#39;</span>
</span><span class='line'>  <span class="no">Rake</span><span class="o">::</span><span class="no">JavaExtensionTask</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;GEM_NAME&#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">else</span>
</span><span class='line'>  <span class="nb">require</span> <span class="s1">&#39;rake/extensiontask&#39;</span>
</span><span class='line'>  <span class="no">Rake</span><span class="o">::</span><span class="no">ExtensionTask</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;GEM_NAME&#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h4>rake-compiler流にディレクトリ構成を直す</h4>

<p>ext直下にextconf.rbがある場合は、ext/GEM_NAME/extconf.rb の形になるようにディレクトリ構成を変更します。</p>

<h4>ためしてみる</h4>

<p>rake compile してみる</p>

<pre><code>$ rake compile
mkdir -p tmp/x86_64-linux/jpeg/1.9.3
cd tmp/x86_64-linux/jpeg/1.9.3
/home/masaki/.rvm/rubies/ruby-1.9.3-p194/bin/ruby -I. ../../../../ext/jpeg/extconf.rb
checking for jpeglib.h... yes
checking for main() in -ljpeg... yes
creating Makefile
cd -
cd tmp/x86_64-linux/jpeg/1.9.3
make
compiling ../../../../ext/jpeg/jpeg_jpeg.c
../../../../ext/jpeg/jpeg_jpeg.c: In function ‘jpeg_jpeg_exit’:
../../../../ext/jpeg/jpeg_jpeg.c:32:5: warning: format not a string literal and no format arguments [-Wformat-security]
compiling ../../../../ext/jpeg/jpeg.c
compiling ../../../../ext/jpeg/jpeg_error.c
linking shared-object jpeg.so
cd -
install -c tmp/x86_64-linux/jpeg/1.9.3/jpeg.so lib/jpeg.so
</code></pre>

<p>環境が汚れなさそうなのは確認できましたね。</p>

<p><em>warning直さないと・・・</em></p>

<h4>travisに教える</h4>

<p>.travis.yml に以下を追加 (もちろん前のは消して)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">before_script</span><span class="p-Indicator">:</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">rake compile</span>
</span></code></pre></td></tr></table></div></figure>


<h4>travisのログ確認</h4>

<pre><code>39$ rake compile
40mkdir -p tmp/i686-linux/jpeg/1.8.7
(中略)
54install -c tmp/i686-linux/jpeg/1.8.7/jpeg.so lib/jpeg.so
</code></pre>

<p>環境も汚してないしテストも通りました! やったね!</p>

<h2>参考</h2>

<ul>
<li><a href="https://travis-ci.org/#!/masarakki/jpeg">Travisの実行結果</a></li>
<li><a href="https://github.com/masarakki/jpeg">テスト対象プロジェクト</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/blog/2012/10/30/home-server-aboned/">自宅鯖があぼーんした</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-10-30T02:26:00+09:00" pubdate data-updated="true">Oct 30<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>事の起こり</h2>

<p>今日の朝起きたらtwitterのリロードができなくてブラウザが腐ったのかと思った。
ブラウザ再起動しても状況改善せず。
よくよく気づいてみたら妙に部屋が静かだ・・・ 見てみたらサーバちゃん息してないの・・・
サーバマシンはPPPoE接続とルーティングもやらせていたのでそれも止まってしまったという状態。</p>

<h2>サーバの状況</h2>

<p>起動してみたらfsckしろよクソって言われた。
(最近ずっと怪しかったけど)ディスクやべーのかなぁ、
(ずっと気にかかってたけど)とうとう逝ったのかなぁ、
(ここ数年ずっとそうだけど)カネねえなぁとか思いながらfsck実行してみる。
fsckが全然終わらなくてそのままにして仕方なく仕事行く。</p>

<p>仕事終わって家に帰ったら妙な臭いがする。
サーバの電源落ちてる。</p>

<h2>なぜ落ちてたか</h2>

<p>もっかい電源入れてみる。
なんか定期的にブンって音がするような気がする。
箱の中覗いてみたらCPU1のファンが数秒に1回、数センチしか動いてない!!
CPU2のファンなんて全く動いてない!!!
ケースの一部が透明になってるのが初めて役に立った。</p>

<p>ファンを指で回してみようと思ったけど硬くて動かない。
ホコリとか詰まって硬くなってるのかな?
ファン外してみたらCPU表面が焦げてるような感じ。
臭いの理由と電源落ちてた理由はこれか・・・</p>

<p>シングルユーザモードでの起動はギリギリ大丈夫なようだ</p>

<h2>ネットワーク復旧作業</h2>

<p>とりあえず起動してfsckだけ終わらせた。
/homeは巨大なのでとりあえず無視。
/usrが読めるようになったのでとりあえずPPPoEの設定が読めた。
無線LAN構築に使ってるAPがルータにもなるのでPPPoEを喋らせてみる。
設定ドキュメントがなかなか難しくて困った。
なんで家電化された機器はあんなに設定が難しいんだろう・・・
ネットワーク構成変更中にAPをもともと繋いでたはずのLANケーブルが消失する。
どこいったんや・・・
死んだサーバを繋ぐケーブルがない。</p>

<p>fsckが終わってディスクのマウントできるようになった。
通常起動もできるはずだが、起動プロセス中にリブートかかる。
ここから先は無理っぽい。</p>

<h2>障害範囲</h2>

<ul>
<li>ネットワーク全般

<ul>
<li>APをルータにして復帰</li>
</ul>
</li>
<li>web

<ul>
<li>全部herokuに移してしまおうかと画策</li>
<li>この時期コミケ準備会とか見に来るっぽいからまじヤバイ タイミング最悪</li>
<li>mysqlのデータdumpだるい</li>
</ul>
</li>
<li>ストレージ

<ul>
<li>一部復旧できないかも</li>
<li>大量のエロ画像の運命は!?</li>
</ul>
</li>
</ul>


<h2>サーバ復旧作業予定</h2>

<ul>
<li>新しくCPUファン買って付け直せばなんとか起動してくれるかなぁ・・・

<ul>
<li>AM2時代のOpteron用ファンなんて見つかるのかね</li>
</ul>
</li>
<li>webサーバはクラウドに持って行きたいなぁ</li>
<li>ストレージだけ手元に持たないといけないからそれどうしよう</li>
<li>確か1TBのディスクが入ってるからそれ経由して他のマシンのHDDにデータ移動できるかな

<ul>
<li>RAIDがむしろ邪魔</li>
</ul>
</li>
<li>圧倒的にカネが足りない</li>
</ul>


<h2>突然ネットワークが使えなくなって気づいたこと</h2>

<ul>
<li>LANケーブル何本か余分に持っていたほうがいい</li>
<li>テザリングさえあれば何とかなる</li>
<li>タブレット超便利</li>
<li>視覚よりも聴覚・嗅覚</li>
<li>nasneはネットワークが切れてPS3から見えてなくても問題なく動く

<ul>
<li>繋げた瞬間に録画済み動画がどかっと増えた</li>
<li>障害中のもバッチリ撮れてた</li>
<li>上手く設計できてると感心した</li>
</ul>
</li>
<li>ファンが回らなくなったのは初めて サーバ止めずに掃除とかできんの?</li>
<li>トラブル楽しい

<ul>
<li>嘘。死ね</li>
</ul>
</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/blog/2012/10/18/gem-src/">Gem-src</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-10-18T00:13:00+09:00" pubdate data-updated="true">Oct 18<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="https://github.com/amatsuda/gem-src">gem-src</a> がすごく便利。</p>

<h2>よくあるパターン</h2>

<h3>1. gemのソースコードを読みたい時</h3>

<p>gemを使ってるとソースをがっつり追いたくなる時がありますが、そんな時どうしてますか?
最近編み出したのが、とりあえずインストールされたgemをgitに突っ込むというワザです。</p>

<p>rvmを使っているのでこんな感じに。</p>

<pre><code>$ cd ~/.rvm/gems/ruby-1.9.4-p194@hoge/gems/hoge_gem
$ git init; git add .
$ git grep hogehoge
</code></pre>

<p>これでも十分に便利ですけど、gemのディレクトリまで行くのが面倒ですよねー。</p>

<h3>2. gemに Pull Request したい時</h3>

<p>gemの名前は知っていても誰が作ったかなんて覚えてませんよね。
hubコマンドもユーザ名がわからないと使えません。
(なぜか hub clone rails はできるんだけどなんでだろう・・・)
結局githubで検索してリポジトリを探さないといけません。</p>

<h2>gem-srcを使う</h2>

<p>gem-srcを使うと、gem install した時に同時にgithubからソースコードを git clone してくれます。
その前に .gemrc にダウンロードするディレクトリを設定しておきましょう。</p>

<pre><code>$ echo "gemsrc_clone_root: ~/src/gems" &gt;&gt; ~/.gemrc
</code></pre>

<p>この状態でgem install してみましょう。</p>

<pre><code>$ gem install ero_getter
Fetching: zipruby-0.3.6.gem (100%)
Building native extensions.  This could take a while...
Fetching: ero_getter-1.6.0.gem (100%)
Cloning into '/home/masaki/src/gems/ero_getter'...
remote: Counting objects: 665, done.
remote: Compressing objects: 100% (310/310), done.
remote: Total 665 (delta 306), reused 634 (delta 278)
Receiving objects: 100% (665/665), 274.95 KiB | 165 KiB/s, done.
Resolving deltas: 100% (306/306), done.
Successfully installed zipruby-0.3.6
Successfully installed ero_getter-1.6.0
2 gems installed

$ ls ~/src/gem
./  ../  ero_getter/  gem-src/
</code></pre>

<p>入りましたね!</p>

<pre><code>$ cd ~/src/gem/ero_getter
$ git remote show origin
* remote origin
  Fetch URL: http://github.com/masarakki/ero_getter
    Push  URL: http://github.com/masarakki/ero_getter
</code></pre>

<p>hubでforkした時と同じ状態なのでそのままhubコマンドでforkも Pull Request もできそうです。</p>

<pre><code>$ hub fork
$ hub pull-request
</code></pre>

<p>やったーforkできたよー多分 Pull Request もできるよー</p>

<h2>条件</h2>

<p>gemのメタデータにあるhomepageの項目がgithubっぽかったらcloneするらしいです。
なのでみんなhomepageはgithubのurlにしましょう。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/blog/2012/10/07/make-yukkuri-to-use-accent/">ゆっくりにアクセントをつけてみた</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-10-07T03:21:00+09:00" pubdate data-updated="true">Oct 7<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>あらすじ</h2>

<p><em><a href="http://masarakki.github.com/blog/2012/09/22/yukkurid/">前回</a>、
棒読みちゃんと同じAquesTalkという音声合成エンジンを使い、
Linuxでも棒読みができるアプリケーションyukkuriを作った俺。</em></p>

<p><em>ところがこのyukkuriには致命的な欠陥があったのだ!!</em></p>

<h2>実際に喋らせてみた</h2>

<p>棒読みちゃん以上に棒読みだった。
完全に真っ平ら。ぺったんこ。
<strong>実は棒読みちゃんは棒読みじゃなかった</strong></p>

<p>どうやらAquesTalkは自分でアクセント記号を付けないといけないようです。
棒読みちゃんにもアクセント付きに変換された文字列が表示されます。</p>

<h2>アクセントの付け方</h2>

<p>やはりこのままmecabを使いたいので 「mecab アクセント」 でぐぐってみたところ、
<a href="http://www.tokuteicorpus.jp/dist/">Unidic</a>というmecab用アクセント辞書があるようです。
これを組み込めばアクセントがうまく処理できそうです。</p>

<p>アクセントの仕様はかなり複雑なので一部から実装していきます。
実際にニコ生で使って気になるアクセントがあったらテストを書いて修正していくという方法を取ります。</p>

<h2>アクセントのテストデータ</h2>

<p>アクセントの処理を実装するにあたって、もちろんテストデータが必要になります。</p>

<h4>方法1. 棒読みちゃんに喋らせてみてアクセント付き文字列を使う</h4>

<p>残念ながらLinuxではWineを使っても棒読みちゃんが動かなかったので断念。</p>

<h4>方法2. TASETのデモページを使う</h4>

<p><a href="https://sites.google.com/site/suzukimasayuki/accent">CRFを用いたアクセント結合推定</a>
というなんか難しいサイトの <a href="http://www.gavo.t.u-tokyo.ac.jp/~suzuki/taset_demo/">デモページ</a>
で文章にアクセントをつけることができます。
ただし変換にかなり時間がかかり、実際に喋らせてみるとなんかちょっと変です。</p>

<h4>方法3. 聞く</h4>

<p>2で作ったアクセントを実際に喋らせてみて、
自然に聞こえるように微調整するのが一番良さそうです。</p>

<p>ただし、細かい部分では<strong>正しい</strong>日本語の発音なんてのは知らないので、
こんなもんなのかで済ませます。</p>

<h2>結果</h2>

<p>たぶん棒読みちゃんより正確なアクセントが付けれるようになった。
確認は<a href="https://github.com/masarakki/yukkurid">コード</a>を実行してみるか、
<a href="http://com.nicovideo.jp/community/co600306">ニコ生の放送</a>を見てくださいな。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/blog/2012/09/22/yukkurid/">Yukkurid</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-09-22T06:59:00+09:00" pubdate data-updated="true">Sep 22<span>nd</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><em>ゆっくりしていってね!</em></p>

<h2>yukkuridとは?</h2>

<p>棒読みちゃん+デーモン</p>

<p>ニコ生をするのに欠かせないの棒読みちゃんというWindowsアプリがありますが、
もちろんWindowsアプリなのでLinuxでは動きませんしWineで動くとしても動かしたくないですよね。</p>

<p>でもやっぱり棒読み機能がないと不便なので作ってみました。</p>

<p><a href="https://github.com/masarakki/yukkurid">yukkurid</a></p>

<h2>棒読み部分</h2>

<p>棒読みちゃんは内部で<a href="http://www.a-quest.com/">AquesTalk2</a>という読み上げライブラリを使用していて、
これはWindows版だけでなくMacOS版とLinux版のライブラリも配布されています。
<strong>(ただし有料)</strong></p>

<p>棒読みにはそんなに機能は必要無いので、ほとんどサンプルファイルをそのままコンパイルして、
十分実用なバイナリになりました。</p>

<h2>デーモン部分</h2>

<p>sinatraでちょちょっと作って終了です。
POSTで受け取ったデータを、漢字が読めない棒読みちゃんのためにmecabで読みに変換して、
棒読みちゃんに渡して吐かれたwavをALSAに食わせる。
ワンライナーで瞬殺です。</p>

<p>これでPOSTで送信するとコンピュータがゆっくり喋ってくれるようになりました!</p>

<h2>次の展望</h2>

<p>デーモンにさえすれば、実際にニコ生のコメントをchrome extensionから送信して、
コンピュータが喋ってくれるようになるはずです。
EroGetterの時もそうだったけどいちいちデーモンにするのがめんどくさいですがしかたないですね・・・</p>

<p>というわけでchrome extensionのコメビュを作るか既存のをどっかからパクってきて繋ぎこみたいと思います。</p>

<p>あとは今だと喋ってる間ブロックするので非同期化と、それにともなってちゃんとしたキューイングを。</p>

<h2>ところで</h2>

<p><a href="http://www.a-quest.com/licence_free.html">非商用の個人の開発ライセンス</a>を買ったのですが、</p>

<ul>
<li>アプリの機能として、外部ソフトから当社製品ライブラリの機能を呼び出し可能なインターフェースを持たないこと。</li>
</ul>


<p>ってどういうことなんだろう?
これをラップした raques.gem みたいなのは作っちゃダメなのかな?
.soと.hは自分で用意してねっていう形でならok?
といっても今コンパイル済みバイナリを ./bin/yukkuri に置いてるけど、これも.so無いと動かないよね?
かといって.so同梱できるようなライセンスじゃないよね? そんなんしたら商売上がったりだよね?
あんまC方面わからんからこのライセンスが一体何をしてよくて何をしていけないのかわからない。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/blog/2012/09/20/how-to-hide-json-values-in-loggin/">RailsログでJSONの一部を隠す方法</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-09-20T05:10:00+09:00" pubdate data-updated="true">Sep 20<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Rails のログ出力には filter_parameters という一部のパラメータを隠す便利な機能があります。</p>

<p>デフォルトでは config/application.rb に</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">filter_parameters</span> <span class="o">+=</span> <span class="o">[</span><span class="ss">:password</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>と書かれています。</p>

<p>ここにフィルタしたいパラメータを追加すれば [FILTERED] という文字列に置き換えられます</p>

<p>例えば開発者が user_id を見てはいけない社内ルールがある場合</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">filter_parameters</span> <span class="o">+=</span> <span class="o">[</span><span class="ss">:password</span><span class="p">,</span> <span class="ss">:user_id</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>とすればいいわけです。</p>

<h2>ためしてみる</h2>

<h3>GETの場合</h3>

<pre><code>GET /posts?password=abc123
</code></pre>

<p>を叩いた場合ログに</p>

<pre><code>Started GET "/posts?password=[FILTERED]" for 127.0.0.1 at 2012-09-20 05:16:44 +0900
Processing by PostsController#index as HTML
  Parameters: {"password"=&gt;"[FILTERED]"}
</code></pre>

<p>とURLもパラメータも [FILTERED] に変えられて出力されます。</p>

<h3>POSTの場合</h3>

<pre><code>POST /posts
data: password=abc123
</code></pre>

<p>を叩いた場合ログは</p>

<pre><code>Started POST "/posts" for 127.0.0.1 at 2012-09-20 05:18:12 +0900
Processing by PostsController#create as */*
  Parameters: {"password"=&gt;"[FILTERED]"}
</code></pre>

<p>上手いことフィルタされますね。</p>

<p>Rails の標準的なPOSTパラメータ形式の :post => {:password => &#8220;abc123&#8221;} はどうでしょうか</p>

<pre><code>Started POST "/posts" for 127.0.0.1 at 2012-09-20 05:22:33 +0900
Processing by PostsController#create as */*
  Parameters: {"post"=&gt;{"password"=&gt;"[FILTERED]", "title"=&gt;"unko"}}
</code></pre>

<p>これもきちんとフィルタできてます。</p>

<h2>特殊な事情</h2>

<p>ある特殊な事情から「パラメータは json というキーに json 文字列で入ってくる」というプロジェクトがある場合どうなるでしょうか?
ほんとにそんなプロジェクトがあるんでしょうか? ファックですね。
どうせ原因はこのAPIを叩いてくるphpが低脳だからに違いありません。</p>

<pre><code>POST "/post"
data: json={\"password\":\"abc123\"}
</code></pre>

<p>という状況です。 ためしてみましょう。</p>

<pre><code>Started POST "/posts" for 127.0.0.1 at 2012-09-20 05:30:56 +0900
Processing by PostsController#create as */*
  Parameters: {"json"=&gt;"{\"password\":\"abc123\"}"}
</code></pre>

<p>残念、丸見えです! かと言って :json を全部フィルタするのは開発の妨げになってしまいます。</p>

<h3>一番かっこ悪い解決方法</h3>

<p>filter_parameters には、|key, value| を引数に取る lambda を指定することもできるようです。
サンプルでは</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">lambda</span> <span class="k">do</span> <span class="o">|</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="o">|</span>
</span><span class='line'>  <span class="n">v</span><span class="o">.</span><span class="n">reverse!</span> <span class="k">if</span> <span class="n">k</span> <span class="o">=~</span> <span class="o">%</span><span class="n">rsecret</span><span class="o">/</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>と書かれていますが、reverse! と破壊的メソッドを使っているのがすごく嫌な予感がします。
どうやら value のオブジェクトを破壊的に変更しないといけないようです。</p>

<p>こんな感じで書いてみました。</p>

<div><script src='https://gist.github.com/3752166.js'></script>
<noscript><pre><code>config.filter_parameters += [:password, lambda {|k, v|
   if k.to_sym == :json
     json = JSON.parse(v).symbolize_keys
     json[:password] = &quot;[FILTERED]&quot; if json.has_key?(:password)
     v.replace json.to_s
   end
}]</code></pre></noscript></div>


<p>ログの出力結果は</p>

<pre><code>Started POST "/posts" for 127.0.0.1 at 2012-09-20 05:49:22 +0900
Processing by PostsController#create as */*
  Parameters: {"json"=&gt;"{:password=&gt;\"[FILTERED]\"}"}
</code></pre>

<p>上手くいってます!!</p>

<p>ポイントは v.replace でオブジェクト自体は変えずに文字列を変更してる点です。
これを</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">v</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">to_s</span>
</span></code></pre></td></tr></table></div></figure>


<p>とやってしまうと上手く動きません。</p>

<p>とりあえずこれで泣く泣く json の入力すべてを捨てる必要はなくなりました。 やった!!</p>

<h3>問題点</h3>

<ul>
<li>[FILTERED] が定義されているクラスのファイルを require してもクラスが存在しないと言われる? ロード順の問題?</li>
<li>普通に指定されたフィルタしたいパラメータを lambda 内で再利用できない

<ul>
<li>lambda での指定は最後に評価されるので</li>
<li>before_filter (<strong>まさに!</strong>) があれば解決?</li>
</ul>
</li>
</ul>


<h2>ほんとにやりたい一番かっこいい解決方法</h2>

<p>:json が渡ってきた場合は filter とかする前に JSON.parse してハッシュにしたい。
そうすれば普通に filter_parameters += [:password, :user_id] を指定するだけで、
:post => {:password => &#8220;abc123&#8221;} がフィルタできたのと同様にフィルタできるはず。</p>

<p>次はこれを調べる。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/blog/2012/09/18/erogetter-with-your-favorite-site/">EroGetter With Your Favorite Site!</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-09-18T08:06:00+09:00" pubdate data-updated="true">Sep 18<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>EroGetter対応サイトを増やす</h2>

<p>サイト定義を書くことで対応サイトを増やすことができます。</p>

<h3>準備するもの</h3>

<ul>
<li>まともな(ry</li>
<li>対象サイト

<ul>
<li>記事urlの正規表現</li>
<li>サイト名</li>
</ul>
</li>
<li>エロにかける情熱</li>
</ul>


<p>今回追加するサイトは <strong>http://example.com/archives/\d.html えろいぐざんぷるどっとこむ</strong> とします。</p>

<h4>ダウンロード</h4>

<pre><code>git clone git://github.com/masarakki/ero_getter.git
cd ero_getter
bundle install
git checkout -b add_example_dot_com
</code></pre>

<h4>クラス名の決定</h4>

<p>サイト名が <strong>えろいぐざんぷるどっとこむ</strong> なのでクラス名は <strong>EroExample</strong> とします。
通例に従って、ファイル名などは <strong>ero_example</strong> のようなスネークケースになります。</p>

<h4>サンプルファイルの追加</h4>

<pre><code>mkdir spec/samples/ero_example
wget http://example.com/archives/1234567.html -o spec/samples/ero_example/sample.html
</code></pre>

<p>その1〜 のように連番になっているサイトの場合は先頭、中間、最後のファイルをそれぞれ別名で保存してください。</p>

<h4>テストの追加</h4>

<p><em>spec/downloader/</em> にある他のサイト定義のファイルをコピーして、
<strong>spec/downloader/ero_example_spec.rb</strong> を作ります。
連番サイトは <em>nijigazou_sokuhou_spec.rb</em>、 そうでないサイトはそれ以外のファイルがいいでしょう。</p>

<p>ファイルを開いてそれっぽいところを変更します。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">describe</span> <span class="no">EroExample</span> <span class="k">do</span>                                     <span class="c1"># クラス名を変更</span>
</span><span class='line'>  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@dl</span> <span class="p">}</span>
</span><span class='line'>  <span class="n">let</span><span class="p">(</span><span class="ss">:url</span><span class="p">)</span> <span class="p">{</span> <span class="s1">&#39;http://example.com/archives/1234567.html&#39;</span> <span class="p">}</span> <span class="c1"># urlを変更</span>
</span><span class='line'>  <span class="n">before</span> <span class="k">do</span>
</span><span class='line'>    <span class="no">FileUtils</span><span class="o">.</span><span class="n">stub</span><span class="p">(</span><span class="ss">:mkdir_p</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@dl</span> <span class="o">=</span> <span class="no">EroExample</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>                              <span class="c1"># クラスを変更</span>
</span><span class='line'>    <span class="n">fake</span><span class="p">(</span><span class="ss">:get</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="s1">&#39;ero_example/sample.html&#39;</span><span class="p">)</span>             <span class="c1"># サンプルファイルを変更</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="n">its</span><span class="p">(</span><span class="ss">:sub_directory</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="o">==</span> <span class="s1">&#39;1234567&#39;</span> <span class="p">}</span>              <span class="c1"># サブディレクトリ名を変更</span>
</span><span class='line'>  <span class="n">its</span><span class="p">(</span><span class="s2">&quot;targets.count&quot;</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="o">==</span> <span class="mi">26</span> <span class="p">}</span>                    <span class="c1"># サンプルファイルの画像数に変更</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<pre><code>rspec spec/downloader/ero_example_spec.rb
</code></pre>

<p>を実行してFailがひとつも出なくなるようにサイト定義をいじります。</p>

<p>別のターミナルを立てて</p>

<pre><code>bundle exec guard start
</code></pre>

<p>でguardを動かしてCIすることもできます。</p>

<h4>サイト定義の追加</h4>

<p><strong>lib/downloader/ero_example.rb</strong> に、 <strong>EroGetter::Base</strong> を継承したクラスを作ります。
対象サイトがLivedoorBlogの場合は、 <strong>EroGetter::Livedoor</strong> が使える場合もあります。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">EroExample</span> <span class="o">&lt;</span> <span class="no">EroGetter</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="nb">name</span> <span class="s1">&#39;えろいぐざんぷるどっとこむ&#39;</span>
</span><span class='line'>  <span class="n">url</span> <span class="sr">%r{http://example.com/archives/\d+.html}</span>
</span><span class='line'>  <span class="n">target</span> <span class="s2">&quot;a &gt; img.ero-file&quot;</span> <span class="k">do</span> <span class="o">|</span><span class="n">tag</span><span class="o">|</span>
</span><span class='line'>     <span class="n">tag</span><span class="o">.</span><span class="n">parent</span><span class="o">[</span><span class="ss">:href</span><span class="o">]</span> <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">parent</span><span class="o">[</span><span class="ss">:href</span><span class="o">]</span> <span class="o">=~</span> <span class="sr">/jpe?g|gif|png/</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="n">sub_directory</span> <span class="k">do</span>
</span><span class='line'>     <span class="n">url</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sr">/(\d).html/</span><span class="p">)</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="n">filename</span> <span class="p">{</span><span class="o">|</span><span class="kp">attr</span><span class="o">|</span> <span class="s2">&quot;%04d%s&quot;</span> <span class="o">%</span> <span class="o">[</span><span class="kp">attr</span><span class="o">[</span><span class="ss">:index</span><span class="o">]</span><span class="p">,</span> <span class="kp">attr</span><span class="o">[</span><span class="ss">:ext</span><span class="o">]]</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>肝になるのは <strong>target</strong> のところです。
targetで取得したい画像のurlを集める方法を指定します。</p>

<p>targetの引数には取得したいタグをcssで指定します。
そのタグに対してブロックの処理をしてurlを取得します。
最終的に、 <strong>画像のurlの文字列</strong> を集めなければならないことに注意してください。
(ただタグを返すだけだとurl文字列ではないということです)</p>

<p>この例の場合、aタグ直下の、クラスにero-fileが付けられたimgタグを全部持ってきて、
その親要素のhref属性が画像ファイルなら、そのhrefを文字列として返す、という条件になります</p>

<p>rspecを走らせて、取得した画像の件数が一致するまでtargetを調整しましょう。</p>

<h4>連番サイト</h4>

<p>その1〜 など連番で記事が作られるサイトは、ひとつの記事から全てのページを取得する設定が可能です。</p>

<p><em>lib/downloader/nijigazou_sokuhou.rb</em> を参考にしましょう。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">connection</span> <span class="o">[</span><span class="s1">&#39;a[rel=prev]&#39;</span><span class="p">,</span> <span class="s1">&#39;a[rel=next]&#39;</span><span class="o">]</span> <span class="k">do</span> <span class="o">|</span><span class="n">path</span><span class="o">|</span>
</span><span class='line'>    <span class="n">path</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="no">Regexp</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">title_part</span><span class="p">))</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">title_part</span>
</span><span class='line'>     <span class="n">title</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sr">/(.+?)(その.+)?$/</span><span class="p">)</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>connection</strong> で前後のページへのリンクをcssの配列で指定します。
ブロックを渡してtrue/falseを返すことで、そのリンクを本当に取得するかどうかを調整できます。
この場合、タイトルの「その〜」より前の部分が一致したら本当に取得する事になります。</p>

<p>rspecも <em>spec/downloader/nijigazou_sokuhou_spec.rb</em> を参考に、
前後ページが正しく取得できるか、次がなければnilになるか、をテストしましょう。</p>

<h4>Pull Request</h4>

<p>あとはPull Requestすれば取り込まれます。
Pull Requestの前にはコミットをひとつにまとめるとかっこいいですよ。</p>

<pre><code>git rebase -i HEAD~10 (十分大きい数字)
</code></pre>

<p>コミットIDの前の文字列を <strong>s</strong> にすると、その前のコミットと合成されます。
作業をひとつのコミットにまとめて、コミットメッセージを適切なものに直し、
pushしてPull Requestで完成です!</p>

<p><em>Enjoy!</em></p>
</div>
  
  


    </article>
  
  <ul class="pager">
    
    <li class="previous"><a href="/blog/page/2/">&larr; Older</a></li>
    
    <li><a href="/blog/archives">Blog Archives</a></li>
    
  </ul>
</div>
<aside class="sidebar-nav span3">
  
    <section class="well">
  <ul id="recent_posts" class="nav nav-list">
    <li class="nav-header">Recent Posts</li>
    
      <li class="post">
        <a href="/blog/2013/03/22/java-ja-kowai/">java-ja Kowai</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/03/16/make-url-cool/">make url cool</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/02/14/supervisor-with-rvm/">run ruby on supervisor with RVM</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/11/04/how-to-travis-a-gem-with-c-extension/">Travis CIでrubyのC拡張が入ったgemのテストをする方法</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/10/30/home-server-aboned/">自宅鯖があぼーんした</a>
      </li>
    
  </ul>
</section>

<section class="well">
  <ul id="gh_repos" class="nav">
    <li class="nav-header">GitHub Repos</li>
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/masarakki">@masarakki</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        github.showRepos({
            user: 'masarakki',
            count: 6,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/asides/github.js" type="text/javascript"> </script>
</section>



<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/107002572043873162468?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>

    </div>
  </div>
  <footer role="contentinfo" class="page-footer"><hr>
<p>
  Copyright &copy; 2013 - masarakki -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
