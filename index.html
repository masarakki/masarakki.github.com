
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>masarakki's blog</title>
  <meta name="author" content="masarakki">

  
  <meta name="description" content="ほぼ電子書籍に移行して2年くらい経ちました。
ここ1年で紙の本は数十冊しか買ってないと思います。
ほとんどはkindleで、一部の本とエロ本はニコ書で買ってます。
ログを見ると去年1年でkindleで1200冊くらい買ってるようです。
紙で買っているのは最新な技術書、 &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://masarakki.github.com">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="masarakki's blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-20908831-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner">
</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:masarakki.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="nav">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/resume">Resume</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/05/15/migrate-to-ebook/">ほぼ電子書籍に移行した話</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-05-15T01:11:28+09:00" pubdate data-updated="true">May 15<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>ほぼ電子書籍に移行して2年くらい経ちました。
ここ1年で紙の本は数十冊しか買ってないと思います。
ほとんどはkindleで、一部の本とエロ本はニコ書で買ってます。
ログを見ると去年1年でkindleで1200冊くらい買ってるようです。
紙で買っているのは最新な技術書、しばらく電子化されないことが確定している漫画、それと毎月の快楽天くらいです。</p>

<p>ほぼ完全に電子書籍に移行した結果の利点・欠点・変化などをまとめます。</p>

<h2>利点: 部屋が狭くならない</h2>

<p>家には本棚が4本あって、すべて本が詰まっていて、もうこれ以上本棚を置く場所がありません。
これまで紙の本を買うときは、保管をどうするかという罪悪感を感じながら買っていました。
結局置く場所がなくて床に山積みになっていて、足の踏み場がないという状態です。
こんな状態でも電子書籍なら何も気にすること無く購入できます。</p>

<p>逆に電子書籍で買い直しが進んだ結果、本棚1本分くらいは処分できそうです</p>

<h2>利点: いつでも買える</h2>

<p>ポチってダウンロードされるのをちょっと待つだけですぐ読めます。
革命的な便利さです。
amazonの普及により本屋に行くというダルいことをする必要はなくなり、これも十分に革命的でしたが、
人間は怠惰なので、今となってはamazonで注文した荷物を受け取るということがダルくてたまりません。
最近では、受け取ることを考えると億劫でポチる手を躊躇するということもあります。
電子書籍だと荷物を受け取るダルさも回避できるので、あとは本を読むダルさを何とかするだけです。
これに関しては買っても読まないという革命的なソリューションがあります。</p>

<p>さらにいうと、<a href="http://seiga.nicovideo.jp/book/series/15793">一部の本</a>は紙と電子同日発売していますが、
同日発売と言っても一日のスタートは深夜なので実店舗の開店や宅配便の到着より電子書籍の方が圧倒的に早く買えます。</p>

<h2>利点: 積ん読しやすい</h2>

<p>買っても読まないソリューションは完璧ですが、それでも気まぐれに買った本を読みたくなることがあるでしょう。
紙の本が床に積まれている場合、それは<a href="http://ja.wikipedia.org/wiki/%E3%82%B9%E3%82%BF%E3%83%83%E3%82%AF">スタック構造</a>になっています。
同じスタック上に同じシリーズの本が2冊積まれてしまった場合、古い巻が下に、新しい巻が上に積まれることになります。
紙は意外に結構重いので非力な人間ではスタックの途中から読みたい本を抜くことはできません。
この状態ではそのシリーズはもう2度と読み進むことができないことになります。
一方電子書籍は<a href="http://ja.wikipedia.org/wiki/%E3%83%A9%E3%83%B3%E3%83%80%E3%83%A0%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9">ランダムアクセス</a>可能なので、どれだけ積ん読しても任意の巻から読むことができます。</p>

<h2>利点: 軽い</h2>

<p>技術書なら1冊分よりNexus7のほうが軽いです。
漫画でも2-3冊でNexus7のほうが軽くなります。
その軽い端末の中に数日間は活字に困らない数百冊の本が入ります。
必要なのはNexus7を入れるのに十分なサイズのケツポケがあるジーパンです。
端末ドリブンのジーパン選びは本当に重要です。</p>

<h2>利点: オナニーしやすい</h2>

<p>Flash版ニコ書プレイヤーに搭載されたFPSキーバインドにより、
右手が開放され非常にオナニーしやすくなっています。</p>

<h2>欠点: 画質が悪い</h2>

<p>小さな出版社ほどモワレが酷い・・・ 酷い・・・</p>

<h2>欠点: 知らない本に出逢いにくい</h2>

<p>kindleでもまだ全然レコメンドが生きてない感じします。
知らなかった漫画と偶然出逢う機会が紙の頃よりだいぶ減っている実感があります。
これの対処のために週に何度かとらのあなに行って面白そうな本を探してます。
面白そうな本があったら<a href="http://sinkan.net">新刊net</a>に登録してkindle版発売を待ちます。</p>

<h2>欠点: 無限に買える</h2>

<p>物理的な制約から解き放たれた物欲ヤバイ</p>

<h2>欠点?</h2>

<p>世間一般で欠点だと言われてそうなこと</p>

<ul>
<li>電子化されるのが遅い

<ul>
<li>気にしなければおk</li>
</ul>
</li>
<li>貸し借りできない

<ul>
<li>友達いねえよﾊﾞｰｶ</li>
<li>買えばいいだろ</li>
</ul>
</li>
<li>紙の暖かみがどうのこうの

<ul>
<li>そんなものは幻想だ</li>
</ul>
</li>
<li>プラットフォームが死んだらどうなんの?

<ul>
<li>まともなプラットフォームなら別サービスに移行できるように作ってるでしょ</li>
<li>安心して買えばおk</li>
</ul>
</li>
<li>販売停止がありうる

<ul>
<li>覚悟のあるプラットフォームを選べ</li>
<li>エロ本はニコ書で買ってます</li>
</ul>
</li>
<li>目が疲れる

<ul>
<li>どうせ寝てる時以外はモニタ見てんだから一緒だろ</li>
</ul>
</li>
</ul>


<h2>変化</h2>

<ul>
<li>たぶん買う量は増えた</li>
<li>読む量も増えた</li>
<li>本を入れるカバンを持たなくてもよくなった</li>
<li>部屋はこのあと片付く予定</li>
</ul>


<h2>番外編: 電子書籍を仕事にして良かったこと</h2>

<p>電子化されない本の情報が入ってくるので紙の本を買う決断が素早くできる点です。</p>

<p>さて、amazonから届いたあまんちゅの最新刊を読んできます。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/04/29/cho-tuning/">超チューニング祭に参加した</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-04-29T03:43:37+09:00" pubdate data-updated="true">Apr 29<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>ニコニコ超会議3のアサインされたブースは<a href="http://www.chokaigi.jp/2014/booth/cho_jikuken.html">超時空ニコニコ研究所</a>だったはずなんですが、
ブース説明会に参加して1時間半ほど真面目に説明を聞いていたところ、
最後の最後に「4人はハッカソン行ってね」と突然言われて「ファッ!?」ってなったわけです。</p>

<p>というわけで<a href="http://cyoppaya.kunikiya.jp/">超チューニング祭</a>に参加してきました。</p>

<h2>やったこと</h2>

<p><a href="http://github.com/masarakki/chokaigi">成果物</a></p>

<p>フロントエンドの専門知識があるわけでないので
<a href="http://takehora.hatenadiary.jp/entry/2014/04/17/072838">事前に指摘</a>されていたように、
特にフロントを弄ってスピードが改善されるような予感は全くありません。
デザインもできないので提供されたデータ一式には一切手を付けないことにしました。
なので配信周りで速くすることを目論みました。
(全員こっちの方は最低限やってくると思ったのに意外にほとんどの人は全くやってなかった)</p>

<h3>方針</h3>

<ul>
<li>配信を速くする</li>
<li>その処理をスクリプトで自動化する</li>
<li>元ファイルの構造は弄らない</li>
<li>現実に即した複数ページに応用可能なチューニング方法</li>
<li>計測には <a href="http://tools.pingdom.com/fpt/">http://tools.pingdom.com/fpt/</a> を使用</li>
</ul>


<h3>css と js を1ファイル化</h3>

<p>rails の assets pipeline がやっていることそのままです。
html をそのまま使うということで、明らかな罠である遅いサーバから配信されている jquery もあえてそのまま使います。
単純に html をパースして出てくる js と css を前から順に concat していくだけです。
リクエスト数は減らせましたが結局多いのは画像なのであまり意味ないです。</p>

<h3>html と css と js を minify</h3>

<p>rails では js の minify を <code>uglifier</code> を使っているのですが、css では何を使っているのか分からなかったので、
両方できるっぽい <code>yui-compressor</code> を使ってminifyしました。</p>

<p>html はもともと html5 だったので不要なタグをだいぶ削除できます。
<code>h5-min</code> という凄く古い gem を多少修正したら最新の ruby でも動作しました。</p>

<p>それぞれファイルサイズを20%程度削減できました。</p>

<p>この html の minify の段階で元ソースの文法的に間違った部分が悪影響を及ぼし、
レギュレーションを満たさなかったようです。</p>

<p>具体的には</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;/hoge&quot;</span><span class="nt">&gt;</span>
</span><span class='line'> <span class="nt">&lt;p&gt;</span>hoge<span class="nt">&lt;/p&gt;</span>
</span><span class='line'><span class="nt">&lt;/a&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>がアウトだったぽいです。</p>

<p>よく考えたらフロントのチューニングなのにブラウザのレンダリング結果は一度も見てなかったような気がします。</p>

<h3>AWS で配信</h3>

<p>とりあえず assets を s3 にアップロードしました。
これだけでだいぶ速くなります。
デプロイ先のサーバがだいぶアレだったぽいです。</p>

<p>そのあと CloudFront 経由でアクセスできるようにしました。
この効果は絶大で圧倒的に速くなりました。
pingdom の計測結果によると、Connect と Wait にかかる時間が圧倒的に削減されたようです。</p>

<p>ただ、Chrome の Developer Tool で見た場合、 s3 そのままのほうが全体的に速いという結果も出ました。
だいぶ謎いです。</p>

<h3>配信ドメインを増やす</h3>

<p>ブラウザには1つのドメインに対する同時接続は2までという紳士協定が(一応)あります。
CloudFront のドメインをたくさん作ってラウンドロビンすることで同時ダウンロード数を増やしました。
計測結果によると、1ドメインの場合、後半になるにつれて Connect にかかる時間が長くなっていたのが、
複数ドメインの場合ほとんど変化がないことが分かります。</p>

<p>ただ、ブラウザ全体(またはページ単位)での同時接続数もあるらしく、
増やしすぎてもすべて同時ダウンロードというわけにはいきませんでした。
1ドメインの時の Connect もそれほど遅いわけではないので、ほとんど誤差と言えると思います。
期待したほどの効果はありませんでした。</p>

<h2>HTTP compression</h2>

<p>css と js を圧縮して配信という昔ながらの方法は試してみましたが、
CloudFront での設定が面倒だった上に、
Receiving は短くなったものの Waiting が長くなって、合計値は素の状態より遅くなりました。
なぜ Waiting に計上されるのわからないけどこれがファイルを展開する時間なのでしょうか?
ネットワークが十分速い現代はもはや HTTP compression の必要が無いのかもしれません。</p>

<h2>できなかったこと</h2>

<p>画像を sprite 化すればかなり効果的だと予想できますが、
正方形に近くなるように詰め込むアルゴリズムでないと、
無限に非効率になってしまいそうです。
それを考えている時間はなかったので諦めました。</p>

<h2>結論</h2>

<p>RailsとAWS使え</p>

<h2>費用</h2>

<p>ファイル数も少ないし2日間の合計で アクセス数 35,500 転送量 250MB で1ドルもかかりませんでした。
ドメイン作りまくっても追加で費用がかかることもないようです。</p>

<h2>感想</h2>

<p>異種格闘技戦だけど自分のフィールドに持ち込んである程度戦えたような感じします。
結局計測方法の詳細がわからないので再検証できないのが辛いですねー。</p>

<p>あと優勝したデザイナの人のスライド見ても全然意味が分からなかったりしたのが衝撃的。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/02/21/oauth-for-non-engineer/">非エンジニアのためのOAuth講座</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-02-21T02:00:08+09:00" pubdate data-updated="true">Feb 21<span>st</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>OAuthって何?</h2>

<p>いわゆるこういうのです</p>

<p><img src="/images/oauth_auth.png"></p>

<p>最近Twitterで <strong>スパムアプリがおっぱいポロリと勝手につぶやく</strong> といった事件が世間を賑わせています。
このままでは「OAuthは犯罪です!」なんて言い出す人が現れかねないので、
OAuthってどんなものなのか、Twitterを例に誤解されそうなところを簡単に説明したいと思います。</p>

<h2>誤解1: OAuthはユーザ認証の機能である</h2>

<p>多くのWebサイトに <strong>Twitterでログインする</strong> 機能があり、
上の画面をユーザ認証の仕組みだと思っている人は多いと思いますが、 <strong>大間違いです</strong> 。</p>

<p>OAuthは、他のアプリ(サイト)に対して、自分の代わりにTwitterにアクセスする権利を与える仕組みです。
その過程でユーザ情報がとれるので、ログインの代わりに使っているアプリが多いのですが、本来は間違った使い方です。
他のサービスを使ってユーザ認証をする仕組みに <strong>OpenID</strong> というOAuthの兄弟規格のようなものがあるのですが、
対応しているサービスも少なくイマイチ流行ってません。</p>

<p>何はともあれOAuthの許可をすると、Twitterの操作をする権限をアプリに与えてしまします。
信頼できないアプリに対して許可なんか与えたらダメです。
何ができるかは許可画面に書かれているので <strong>よく読みましょう</strong> 。
上の画像の場合は、</p>

<ul>
<li>tweetが読めるよ</li>
<li>フォローしてる人が見れるよ</li>
<li>プロフィール変更できるよ</li>
<li>tweetできるよ</li>
</ul>


<p>と書かれています。</p>

<p>Twitterは親切で何ができないかも書いてあります。</p>

<ul>
<li>ダイレクトメッセージにはアクセスできないよ</li>
<li>パスワードは見れないよ</li>
</ul>


<p>どこまで権利を欲しがるかはアプリによって違うので <strong>きちんと読みましょう</strong> 。</p>

<h4>まとめ</h4>

<ul>
<li>OAuthは他のアプリに権限を渡す仕組みだよ</li>
<li>許可画面はよく読もう</li>
<li>信頼できないアプリを許可したらダメだよ</li>
</ul>


<h2>誤解2: 念のためパスワード変えたほうがいい</h2>

<p>スパム系アプリが流行すると、パスワード変えたほうがいいという人が必ず現れますが、<strong>全く不要です</strong>。
むしろパスワード変えないとヤバイよと煽って来る人は、
<strong>罠にかけようとしている可能性もあるので警戒したほうがいいです</strong>。</p>

<p>まともなサービスなら、OAuthで許可を得ていても <strong>アプリからパスワードは見えないし変更もできません</strong> 。
そもそもパスワードは元の文字列に復元できない方法でデータベースに保存されています。</p>

<p>アプリとサービスは、OAuthの許可を与えた時に発行される <strong>アクセストークン</strong> という文字列を使ってやりとりします。
なのでアプリはパスワードを一切知ることはないし、知る必要もありません。
もしアプリ側でパスワードを入力させようとしてきたら <strong>完全に罠です</strong>。</p>

<p>アプリの許可を取り消せば、アクセストークンが無効化されて、それ以降アプリはアクセスできなくなります。
あとは勝手にされたtweet消したり勝手にされたフォロー外したりは手動でやる必要があります。</p>

<h4>まとめ</h4>

<ul>
<li>パスワードは変えなくていいよ</li>
<li>アプリがパスワード入力を求めてきたら罠だよ</li>
<li>許可を取り消せばそれっきりだよ</li>
<li>ビビって騙されないように</li>
</ul>


<h2>誤解3: OAuthは安全である</h2>

<p>条件が揃えば、結構簡単にアプリのなりすましが可能です。(特にスマートフォンアプリ)</p>

<p>アプリにはいくつかOAuthのための設定がありますが、
それを全く同じにして別のアプリを作ると、本物になりすますことが可能です。</p>

<p>信頼できるアプリを許可をしたあと、自動でアプリに戻って来るタイミングで、
<strong>複数のアプリ候補</strong> (Androidの場合 他のOSは知らん) がある場合は、その中に偽物が含まれていると思っていいでしょう。
まだこの時 <strong>アクセストークン</strong> は発行されていないので、ここでストップすれば乗っ取りは防げます。
しかし、もし間違って偽アプリを選んでしまったら、 <strong>偽アプリがアクセストークンを取得してしまいます</strong>。
つまりその瞬間になりすましが成立します。</p>

<p>アプリ選択画面が出てくるのはまだマシな方で、
もしこれが、もう使ってなくて <strong>アンインストールしたアプリ</strong> と同じ設定を使っていた場合、
アプリ選択画面すら出ずに <strong>偽アプリがアクセストークンを取得してなりすまします</strong>。
過去に許可していて、その許可がまだ有効な場合は <strong>許可画面すら出ずに</strong> 偽アプリがなりすますこともあります。</p>

<p>Webアプリの場合はスマートフォンアプリほどなりすましは簡単ではないですが、
<strong>ドメインごと盗まれた場合</strong> はなりすまし可能です。
<strong>信頼できないDNSを使っている場合</strong> もなりすまし可能です。
サービスを運営する会社が <strong>買収された時</strong> は買収会社の動きに注目したほうがいいです。</p>

<p>なりすまされた場合、許可したアプリ一覧に出てくる名前は <strong>信頼できるアプリ</strong> なので、
何が犯人なのかなかなか気づきにくいです。</p>

<h4>まとめ</h4>

<ul>
<li>アプリ候補が複数出たら怪しいからストップしたほうがいいよ</li>
<li>アプリを消したら許可も取り消そう</li>
<li>定期的にリストをチェックして使ってないアプリは全部取り消そう</li>
<li>犯人がわからない時はアプリの許可を全部取り消せばとりあえず問題解決</li>
</ul>


<h2>さいごに</h2>

<p>OAuthは、ユーザIDやパスワードを漏らすこと無く、他のアプリにアクセス権を与える仕組みで、
過去にあった <strong>IDとパスワードを保存して代理アクセスするアプリ</strong> に比べたら <strong>格段に安全</strong> な手段です。
エンジニア視点からしても、<strong>知らなくていいこと(パスワード)を知らないままでいられる</strong> 非常に便利な仕組みで、
今後さまざまなサービスがOAuthでのアクセスを提供するようになると思います。
そういう時代なので上記の内容を最低限知っておいたほうがいいと思います。</p>

<p>ただやはり気軽に許可できるものではないので、アプリを許可する際はよく読んでよく考えてよく疑ってかかりましょう。</p>

<p>あとOpenIDは事実上死んでいるので <strong>何もできないOAuth</strong> として再定義されるべきだと思います。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/02/16/yamashiro-ga-shinda/">山城が死んだ</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-02-16T10:37:48+09:00" pubdate data-updated="true">Feb 16<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>飯田橋のカフェを貸し切って山城のお別れ会。</p>

<p>LTしたり、花火打ち上げたり、カネ貸したまま返ってこない暴露話をしたり、
山城の恥ずかしいツイートを見ながら遺品山分けゲーム大会したり、
MBAでスイカ割ったり、MBAにベルギービール飲ましたり、
クズが集まってクズなどんちゃん騒ぎをして最高に楽しかった。</p>

<p>ただ、
楽しい場所には必ずいるはずの奴がいない。
いつも輪の中心で延々イジられ続けてるはずの奴がいない。
哀しい。
いたのかもしれないけど生きてる人間には見れない。
哀しい。</p>

<p>つーか死んでんじゃねえよバカ</p>

<p>あと俺が死んだ時もLT大会で盛大に送ってほしいと思った</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/02/15/how-to-create-gem/">Gemの作り方まとめ 普通のgem編</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-02-15T06:39:24+09:00" pubdate data-updated="true">Feb 15<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>会社の人にgemの作り方まとめてくれって言われたので標準的なgemの作り方をまとめます。
標準的な作り方なので他の人が作ったgemを読み解くヒントにもなります。</p>

<p>とはいえ有名なgemは(有名なgemに限って)メッチャクチャだったりするので読みづらかったりします。
歴史が古かったりすると特にね。</p>

<h2>ジェネレータ</h2>

<p>まずはジェネレータを使ってプロジェクトを作りましょう。
昔はいろいろあったけど最近は <code>bundle</code> コマンドで大勢が決定してる感じです。</p>

<pre><code>bundle gem test_gem -t
</code></pre>

<p><code>-t</code> はテストも作成するオプションです。デフォルトでrspecを使うようになってます。
その他のオプションは</p>

<pre><code>bundle help gem
</code></pre>

<p>で確認できます。</p>

<p>Railsプラグインのgemを作る場合は</p>

<pre><code>rails plugin new test_gem
</code></pre>

<p>を使う方法もあります。
別記事で詳しく書く予定です。</p>

<h3>作成されるファイル</h3>

<p>作られるファイルの一覧はこんなかんじです</p>

<pre><code> create  test_gem/Gemfile
 create  test_gem/Rakefile
 create  test_gem/LICENSE.txt
 create  test_gem/README.md
 create  test_gem/.gitignore
 create  test_gem/test_gem.gemspec
 create  test_gem/lib/test_gem.rb
 create  test_gem/lib/test_gem/version.rb
 create  test_gem/.rspec
 create  test_gem/spec/spec_helper.rb
 create  test_gem/spec/test_gem_spec.rb
 create  test_gem/.travis.yml
</code></pre>

<h3>gem名について</h3>

<p>gem名の <code>-</code> はディレクトリ構造に変換されます。
例えば <code>test-gem</code> という名前で作ると <code>lib/test_gem.rb</code> だったところが <code>lib/test/gem.rb</code> のような構造になります。</p>

<p><code>Gemfile</code> 内で</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">gem</span> <span class="s1">&#39;test-gem&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>が正しくロードできるように
<code>lib/test-gem.rb</code> を作ってその中で</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;test/gem&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>するといいでしょう。</p>

<h2>gemspec</h2>

<p>gemの中を見たことがなければgemspecというファイルは初見でしょう。
gemspecファイルはgemのメタデータが書かれています。</p>

<p>生成された直後はこんな内容になっています。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># coding: utf-8</span>
</span><span class='line'><span class="n">lib</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="s1">&#39;../lib&#39;</span><span class="p">,</span> <span class="bp">__FILE__</span><span class="p">)</span>
</span><span class='line'><span class="vg">$LOAD_PATH</span><span class="o">.</span><span class="n">unshift</span><span class="p">(</span><span class="n">lib</span><span class="p">)</span> <span class="k">unless</span> <span class="vg">$LOAD_PATH</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">lib</span><span class="p">)</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;test_gem/version&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="ss">Gem</span><span class="p">:</span><span class="ss">:Specification</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span> <span class="o">|</span><span class="n">spec</span><span class="o">|</span>
</span><span class='line'>  <span class="n">spec</span><span class="o">.</span><span class="n">name</span>          <span class="o">=</span> <span class="s2">&quot;test_gem&quot;</span>
</span><span class='line'>  <span class="n">spec</span><span class="o">.</span><span class="n">version</span>       <span class="o">=</span> <span class="ss">TestGem</span><span class="p">:</span><span class="ss">:VERSION</span>
</span><span class='line'>  <span class="n">spec</span><span class="o">.</span><span class="n">authors</span>       <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;HOGE&quot;</span><span class="o">]</span>
</span><span class='line'>  <span class="n">spec</span><span class="o">.</span><span class="n">email</span>         <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;hoge@example.com&quot;</span><span class="o">]</span>
</span><span class='line'>  <span class="n">spec</span><span class="o">.</span><span class="n">description</span>   <span class="o">=</span> <span class="sx">%q{TODO: Write a gem description}</span>
</span><span class='line'>  <span class="n">spec</span><span class="o">.</span><span class="n">summary</span>       <span class="o">=</span> <span class="sx">%q{TODO: Write a gem summary}</span>
</span><span class='line'>  <span class="n">spec</span><span class="o">.</span><span class="n">homepage</span>      <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>  <span class="n">spec</span><span class="o">.</span><span class="n">license</span>       <span class="o">=</span> <span class="s2">&quot;MIT&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">spec</span><span class="o">.</span><span class="n">files</span>         <span class="o">=</span> <span class="sb">`git ls-files`</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="vg">$/</span><span class="p">)</span>
</span><span class='line'>  <span class="n">spec</span><span class="o">.</span><span class="n">executables</span>   <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">grep</span><span class="p">(</span><span class="sr">%r{^bin/}</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="no">File</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>  <span class="n">spec</span><span class="o">.</span><span class="n">test_files</span>    <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">grep</span><span class="p">(</span><span class="sr">%r{^(test|spec|features)/}</span><span class="p">)</span>
</span><span class='line'>  <span class="n">spec</span><span class="o">.</span><span class="n">require_paths</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;lib&quot;</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">spec</span><span class="o">.</span><span class="n">add_development_dependency</span> <span class="s2">&quot;bundler&quot;</span><span class="p">,</span> <span class="s2">&quot;~&gt; 1.3&quot;</span>
</span><span class='line'>  <span class="n">spec</span><span class="o">.</span><span class="n">add_development_dependency</span> <span class="s2">&quot;rake&quot;</span>
</span><span class='line'>  <span class="n">spec</span><span class="o">.</span><span class="n">add_development_dependency</span> <span class="s2">&quot;rspec&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>まずTODOのところを埋めましょう。
spec.homepage にはgithubのurlを入れましょう。</p>

<p>このファイルで重要なのは依存するgemの設定です。
<code>add_dependency</code> と <code>add_development_dependency</code> を使って必要なgemを追加しましょう。
Gemfileはこの中身を参照しているので変更する必要はありません。</p>

<p>それ以外の設定はなるべくいじらないほうがいいです。</p>

<h2>中身の作成</h2>

<p>まず <code>lib/test_gem.rb</code> を見てみましょう。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s2">&quot;test_gem/version&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">TestGem</span>
</span><span class='line'>  <span class="c1"># Your code goes here...</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>注目するのは TestGem が module だということです。
ここはなるべく module のままで、実際に色々やるのは下の class に任せましょう。</p>

<p>例えば Client という class を作るなら、 <code>lib/test_gem/client.rb</code> を作って</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">TestGem</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Client</span>
</span><span class='line'>    <span class="c1"># codes</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>な感じに書きます。
クラス構造とディレクトリ構造を一致させましょう。</p>

<p>それを <code>lib/test_gem.rb</code> でロードします。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;test_gem/version&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;test_gem/client&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">TestGem</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>ActiveSupportのautoloadを使う場合は、</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;active_support/dependencies&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">TestGem</span>
</span><span class='line'>  <span class="nb">autoload</span> <span class="ss">:Client</span><span class="p">,</span> <span class="s1">&#39;test_gem/client&#39;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>という感じになります。
Railsだと <code>Gemfile</code> に書いたgemを自動でrequireしてくれますが、ここではしてくれないので手動でrequireしなければいけません。</p>

<p>テストもディレクトリ構造を一致させましょう。
最初は <code>spec/test_gem_spec.rb</code> しかありません。
<code>spec/test_gem</code> ディレクトリを作り、 その中に <code>spec/test_gem/client_spec.rb</code> を作るという感じです。</p>

<p><code>guard</code> を使う場合は、</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">guard</span> <span class="ss">:rspec</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">watch</span><span class="p">(</span><span class="sr">%r{^lib/(.+)\.rb$}</span><span class="p">)</span>     <span class="p">{</span> <span class="o">|</span><span class="n">m</span><span class="o">|</span> <span class="s2">&quot;spec/</span><span class="si">#{</span><span class="n">m</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="si">}</span><span class="s2">_spec.rb&quot;</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>と定義すればちょうどディレクトリ構造がぴったり合います。</p>

<h2>実行可能なコマンドを含める</h2>

<p>例えば <code>rspec</code> のような実行可能なコマンドも簡単に含めることができます。
<code>bin</code> ディレクトリを作り、その中に実行ファイルを入れるだけです。</p>

<p>コマンドなのでファイル名に <code>.rb</code> を付けないほうが見栄えがいいです。
例えば <code>bin/run_test_gem</code> というファイル名で</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#!/usr/bin/env ruby</span>
</span><span class='line'>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;test_gem&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="nb">p</span> <span class="ss">TestGem</span><span class="p">:</span><span class="ss">:Client</span><span class="o">.</span><span class="n">new</span>
</span></code></pre></td></tr></table></div></figure>


<p>のような内容にすると、 <code>run_test_gem</code> というコマンドが使えるようになります。</p>

<p>ただし普段rvmを使っているので、これに関してだけは他のシステムだとどうなるかちょっと分からないです。
rvmの場合、直接コマンドを実行せずにラッパースクリプト経由になるので</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="ss">TestGem</span><span class="p">:</span><span class="ss">:Client</span><span class="o">.</span><span class="n">new</span>
</span></code></pre></td></tr></table></div></figure>


<p>だけで動いてしまいます。</p>

<h2>ビルドとかリリースとか</h2>

<p>ビルドやリリースはすべてrakeタスクが用意されています</p>

<pre><code>rake -T
</code></pre>

<p>で確認しましょう。</p>

<p>リリースの前は <code>lib/test_gem/version.rb</code> を手で編集してバージョン番号を上げないといけません。
(これのせいでjewelerが好きだった)</p>

<p>上記の実行可能コマンドを実際に試してみたいときは、<strong>対象ファイルをコミットして</strong></p>

<pre><code>rake install
</code></pre>

<p>でインストールしないと実行できないというよくハマりがちな罠があります。</p>

<h2>実際にどんなふうにクラス書いていけばいいの?</h2>

<p>他のgemをたくさん読みましょう。</p>

<p>よく知られているgemの多くはとにかく<strong>デカイ</strong>です。
構造を把握するだけでもかなり大変です。
小奇麗にまとまったgemを探して読んでみましょう。</p>

<h2>一番大事なこと</h2>

<p>コードにもコミットメッセージにも <strong>日本語を含めるべきではない</strong> 。</p>

<h2>もうちっとだけ続くんじゃ</h2>

<ul>
<li>Railsプラグインの作り方</li>
<li>C拡張を含むgemの作り方</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/12/25/capistrano-env/">不自由なデプロイを強いられてる人のための Capistrano-env ってgemを作った</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-12-25T19:52:42+09:00" pubdate data-updated="true">Dec 25<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>capistrano-env ってgemを作った</p>

<h2>不自由なデプロイを強いられているんだッ</h2>

<p>すべての人間は大きく2種類に分割でき、それは自由なデプロイを許された人間と、不自由なデプロイを強いられた人間です。</p>

<p>不自由なデプロイを強いられる環境とは次のような環境のことをいいます。</p>

<ul>
<li>自動デプロイとかDevOpsとかの文化がない</li>
<li>特定の人しかデプロイの権限がない</li>
<li>その特定の人が現代的なクラウド文化を知らない</li>
<li>偉い人が手動神話を信仰している</li>
<li>システムを動かすのに絶対必須な情報を開発者が知ってはいけない</li>
</ul>


<p>以上はすべて妄想ですがもしかしたらこんな組織が実在するのかもしれません。
世の中には非常に便利なデプロイツールがあるのにこのような組織では上手く使うことが出来ません。</p>

<p>このgemはこのような不自由なデプロイを駆逐し、自由なデプロイの尖兵として賭けの攻勢に出るための武器です。</p>

<h2>秘密情報という曲者</h2>

<p>組織によっては開発者が知ってはいけない情報が設定されている場合があります。
DBサーバのパスワードやSALTなど、まあこのへんは納得できるんですが、
自分たちのAPIサーバのドメイン名を知らなかったり、何台のサーバで動いてるのかすら知ってはいけない、
なんて組織がもしかしたらあるかもしれません。</p>

<p>このあたりの情報は普通 <code>config/database.yml</code> とかに書いてリポジトリにコミットするわけですが、
秘密情報を含むファイルは作れないのでコミットできないことになります。
以前はどのようにしていたかというと、 <code>config/database.yml.template</code> とかのファイルをコミットし、
ローカルやテスト環境ではそれを <code>config/database.yml</code> にリネームするし、
本番にデプロイするときはインフラ担当が <em>手動で</em> 正しい情報に書き換えて配置します。</p>

<p>はいこんな思想で自動化できるわけがないですよね。
それどころかフレームワーク標準のファイルが存在しないという状況は開発者のCIすら阻害されてしまいます。</p>

<h2>heroku的解決</h2>

<p>設定をコードから分離するための仕組みとして、
herokuにはアプリケーションごとにconfigが設定できるようになってます。
アプリケーションからは環境変数を通してその値にアクセスできます。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>heroku config:set FOO=123</span></code></pre></td></tr></table></div></figure>


<p>こんなかんじに設定すると</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;FOO&#39;</span><span class="o">]</span> <span class="c1"># =&gt; 123</span>
</span></code></pre></td></tr></table></div></figure>


<p>でアクセスできます。便利!
これなら同じコードを全く変更すること無く別のherokuアプリケーションとして動かすこともできますね。</p>

<h2>capistranoでENV設定</h2>

<p>capistranoでデプロイするときに、環境変数付きでサーバを起動することができます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">set</span> <span class="ss">:default_environment</span><span class="p">,</span> <span class="no">ENV</span><span class="o">.</span><span class="n">select</span><span class="p">{</span> <span class="o">|</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="o">|</span> <span class="n">k</span> <span class="o">=~</span> <span class="sr">/^MYAPP_/</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>とか書けば <code>MYAPP_</code> から始まる環境変数を全部デプロイ時に渡すことができます。
アプリ側は ymlファイルの値が書いてある部分を <code>&lt;%= ENV['MYAPP_XXX'] %&gt;</code> とかに置き換えて、
ymlを読む前に一回 Erb を通すようにすれば完成です。</p>

<p>これでデプロイ担当者のマシンに環境変数を設定し、
そのマシンからcapistranoで自動化されたデプロイができるようになりました。</p>

<p>develop/test/staging なんかの環境は別に秘密じゃないとおもうのでymlに即値で書いてしまいましょう。</p>

<h2>unicornリスタート問題</h2>

<p>unicornは一瞬もサービスが途切れること無くサーバのリスタートができるのが特徴ですが、
これはシグナルを送ることによって実現しているので、
<strong>ENVを使った場合はリスタートしても設定の変更ができない</strong> という問題があります。</p>

<p>ENVを更新しようとすると一旦unicornをstopしてstartしなくてはいけません。
これではunicornの良さが損なわれるのでなるべくやりたくない方法です。</p>

<p>ここまで辿り着いた段階でもう既存の方法では厳しいと思いgemを作りました。</p>

<h2>capisrano-env がやっていること</h2>

<p>やってることは単純です。
環境変数を付けてデプロイするのをやめて、
代わりに <strong>環境変数を設定するファイル(コード)</strong> を一緒にデプロイします。
unicornをリスタートする前にも環境変数ファイルを毎回デプロイします。
動かすアプリケーションがRailsの場合は、
勝手にそのファイルを読み込んでrailsのブート中に環境変数を書き換えます。
<code>config/application.rb</code> などでymlの読み込みを始める前にはすでに環境変数が設定された状態になっています。</p>

<p>環境変数を設定するコードを実行するっていう気持ち悪さはありますが、
不自由な環境にいながら自動デプロイで幸せになるためにはこの方法しか考えられませんでした。
まぁ不自由な環境が実在するかどうかは定かではありませんが。</p>

<h2>使いかた</h2>

<p>deploy.rb</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;capistrano-env&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">capenv</span><span class="o">.</span><span class="n">use</span> <span class="k">do</span> <span class="o">|</span><span class="n">env</span><span class="o">|</span>
</span><span class='line'>  <span class="n">env</span><span class="o">.</span><span class="n">add</span> <span class="sr">/^MYAPP_/</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>ここまで書いててこれ自分で設定しなくて default_environment 拾ってくればいいんじゃねえのと思った</p>

<p>あと環境変数を設定するコードを吐く部分はフォーマッタって形で切り出してるから PhpFormatter とか作りたい人作っていいよ</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/03/22/java-ja-kowai/">Java-ja Kowai</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-03-22T22:16:00+09:00" pubdate data-updated="true">Mar 22<span>nd</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>java-ja.DDD 行ってきました</h1>

<p><strong>java-ja 怖い</strong></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/03/16/make-url-cool/">Make Url Cool</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-03-16T17:53:00+09:00" pubdate data-updated="true">Mar 16<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>Railsでurlをカッコ良くする</h2>

<p>railsで普通にこんな感じに config/route.rb を書くと、</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">resources</span> <span class="ss">:genres</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">resources</span> <span class="ss">:books</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>urlはこんな感じになります。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="sr">/genres/</span><span class="mi">1</span><span class="o">/</span><span class="n">books</span>
</span></code></pre></td></tr></table></div></figure>


<p>1ってなんだよ! 1って!!</p>

<h2>urlにidじゃないものをつかう</h2>

<p>ジャンルのようなある程度数が決まっていて名前も変化しなさそうなのは、</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="sr">/genres/</span><span class="n">comic</span><span class="o">/</span><span class="n">books</span>
</span></code></pre></td></tr></table></div></figure>


<p>みたいなurlにできるとカッコイイですよね。</p>

<p>genre_books_path(genre) のメソッドで、genre.idではなくgenre.nameにできれば上手くいきそうです。
このメソッドを調べると(追っていくのメチャメチャ難しかった)、
どうやら to_param というメソッドを経由して id が呼ばれていました。
このto_paramを書き換えてnameを返すようにしてしまっていいのでしょうか?</p>

<p>そこで <a href="http://api.rubyonrails.org">http://api.rubyonrails.org</a> でto_paramを探すと、「ActionPackでurlを作るときに使うよ!」と、
しかもまさにやりたいことそのままのサンプルコードが置いてありました。</p>

<p>というわけで <strong>to_param を書き換えてしまえばid以外にも自由にurlを作れる</strong> ことがわかりました。</p>

<h2>to_param って・・・</h2>

<p>url作るキーを取得するメソッドが to_param ってそんなの検索できねーよ・・・
名付けがクソだと人生の貴重な時間を無駄にするという例でした。</p>

<h2>本当にやりたいこと</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="sr">/comics</span>
</span><span class='line'><span class="sr"> /no</span><span class="n">vels</span>
</span></code></pre></td></tr></table></div></figure>


<p>みたいなurlにしたい。 resourcesをきちんと使って。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/02/14/supervisor-with-rvm/">Run Ruby on Supervisor With RVM</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-02-14T16:17:00+09:00" pubdate data-updated="true">Feb 14<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>supervisorとは</h2>

<p>supervisorとは、pythonで書かれたプロセス監視ツールです。
簡単にインストールでき、デーモンとして動作し、
マシンブート時に任意のプログラムを立ち上げたり、そのプロセスが死んだ時に自動再起動などができます。</p>

<p>動かすプログラムは、単純な無限ループするようなコードでよく、
プロセス永続化などの面倒な仕事は全部supervisorに任せてしまえます。</p>

<h2>RVMで使う時の問題点</h2>

<p>RVMは個人環境にrubyをインストールし、実行するためには環境変数の整備などが必要で、
通常はシェルの起動時に設定スクリプトを読み込んで上手いことやってくれます。
ですが、supervisorを使う場合その方法が取れないのでなんとかしないといけません。</p>

<p>supervisorはenvironmentで環境変数を設定できるのですが、</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ rvm env</span></code></pre></td></tr></table></div></figure>


<p>で出力した環境変数を使っても上手くいきませんでした。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>command=which bundle</span></code></pre></td></tr></table></div></figure>


<p>は想定したpathを返すのですが、</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>command=bundle exec ...</span></code></pre></td></tr></table></div></figure>


<p>にすると bundle not found. と・・・</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>command=cd /path/to/project ; bundle exec ...</span></code></pre></td></tr></table></div></figure>


<p>にしてみても、上手いこと解釈してくれないし、そもそもcdを見つけてくれません。 (シェル組み込みコマンドだから?)</p>

<p>もう意味わかりません。</p>

<h2>そう言えば昔wrapperってあったよね</h2>

<p>そういえば昔まだbundlerがなくてpassengerが主流だったときは、
rvm wrapper とかいうのやってそれを使えって書いてあるサイトが多かったと思います。
なんかマルっと環境を上手いことやってくれるものだっていう認識でした。
試してみましょう。</p>

<p>なんか適当に名前を付けてwrapperを作ります。
gemsetも一緒に hoge_task とかの名前にします。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ rvm wrapper 1.9.3-p385@hoge_task hoge_task bundle</span></code></pre></td></tr></table></div></figure>


<p>これで $HOME/.rvm/bin に hoge_task_bundle というコマンドができあがりました。
実際にフルパスでこのコマンドを叩くと hoge_task のgemsetを使ってbundleが動いているのがわかります。
supervisorのcommandの設定にこれを使えば良さそうです。</p>

<p>supervisorの設定ファイルは全体でこんな感じです</p>

<h3>/etc/supervisor/conf.d/hoge_task.conf</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[program:hoge_task]
</span><span class='line'>command=/home/{USERNAME}/.rvm/bin/hoge_task_bundle exec rackup -p 8000
</span><span class='line'>autostart=true
</span><span class='line'>autorestart=true
</span><span class='line'>stopsignal=QUIT
</span><span class='line'>stdout_logfile=/var/log/hoge_task/out.log
</span><span class='line'>stderr_logfile=/var/log/hoge_task/err.log
</span><span class='line'>user={USERNAME}
</span><span class='line'>diretory=/home/{USERNAME}/projects/hoge_task</span></code></pre></td></tr></table></div></figure>


<p>あとは</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo supervisorctl reload
</span><span class='line'>$ sudo supervisorctl status</span></code></pre></td></tr></table></div></figure>


<p>とかやって設定を読み込み直し、結果を見てみましょう。
多分うまく動き出してるはずですよ!</p>

<h2>Gemfileやruby自体の更新</h2>

<p>プログラムを変更してGemfileが変わった時や、
rubyのバージョンアップをした時などはどうなるのでしょうか?</p>

<p>これもGemfileのアップデートなら</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ bundle install</span></code></pre></td></tr></table></div></figure>


<p>で、いつもどおりgemをインストールした後、(もちろん @hoge_task のgemsetを使って!)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo supervisorctl restart hoge_task</span></code></pre></td></tr></table></div></figure>


<p>でプロセスを再起動すればいいはずです。</p>

<p>rubyを更新した場合は、新しいバージョンを指定してrvm wrapperを作りなおせば、
hoge_task_bundle の中身が書き換えられるので、supervisorの設定はそのままで大丈夫です。
あとは上と同様に bundle install してプロセスの再起動を指示します。</p>

<h2>もう何も怖くない</h2>

<p>これはsupervisorの設定と言うよりむしろ、
ユーザ環境にインストールされたrvmをシステムに近いところで使う汎用的な方法のようです。
自動でrackアプリを起動したり、バックグラウンドでタスクを回したり、いろいろできるようになりました。</p>

<p>というわけで仕事で使うメモでした。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/11/04/how-to-travis-a-gem-with-c-extension/">Travis CIでrubyのC拡張が入ったgemのテストをする方法</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-11-04T17:11:00+09:00" pubdate data-updated="true">Nov 4<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>No Such File</h2>

<p>C拡張が含まれたgemをそのままTravisに流してみると、</p>

<pre><code>$ bundle exec rake
56/home/vagrant/.rvm/rubies/ruby-1.8.7-p358/bin/ruby -S rspec spec/jpeg_spec.rb
57/home/vagrant/builds/masarakki/jpeg/spec/../lib/jpeg.rb:2:
  in `require': no such file to load -- jpeg.so (LoadError)
</code></pre>

<p>自分でコンパイルしないといけないみたいですね。</p>

<h2>とりあえずやってみた</h2>

<p>試しに.travis.ymlでコンパイルの命令を追加してみました。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">before_script</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">cd ext ; ruby extconf.rb ; make install</span>
</span></code></pre></td></tr></table></div></figure>


<p>やった! Travisがテスト全部通したよ!!!</p>

<p>Travisの実行ログを見てみると、</p>

<pre><code>55$ cd ext ; ruby extconf.rb ; make install
56checking for jpeglib.h... yes
57checking for main() in -ljpeg... yes
58creating Makefile
59gcc -I. -I. -I/home/vagrant/.rvm/rubies/ruby-1.8.7-p358/lib/ruby/1.8/i686-linux -I. -DHAVE_JPEGLIB_H  -D_FILE_OFFSET_BITS=64  -fPIC -g -O2  -fPIC   -c jpeg.c
60gcc -I. -I. -I/home/vagrant/.rvm/rubies/ruby-1.8.7-p358/lib/ruby/1.8/i686-linux -I. -DHAVE_JPEGLIB_H  -D_FILE_OFFSET_BITS=64  -fPIC -g -O2  -fPIC   -c jpeg_error.c
61gcc -I. -I. -I/home/vagrant/.rvm/rubies/ruby-1.8.7-p358/lib/ruby/1.8/i686-linux -I. -DHAVE_JPEGLIB_H  -D_FILE_OFFSET_BITS=64  -fPIC -g -O2  -fPIC   -c jpeg_jpeg.c
62gcc -shared -o jpeg.so jpeg.o jpeg_error.o jpeg_jpeg.o -L. -L/home/vagrant/.rvm/rubies/ruby-1.8.7-p358/lib -Wl,-R/home/vagrant/.rvm/rubies/ruby-1.8.7-p358/lib -L.  -rdynamic -Wl,-export-dynamic    -Wl,-R -Wl,/home/vagrant/.rvm/rubies/ruby-1.8.7-p358/lib -L/home/vagrant/.rvm/rubies/ruby-1.8.7-p358/lib -lruby -ljpeg  -lrt -ldl -lcrypt -lm   -lc
63/usr/bin/install -c -m 0755 jpeg.so /home/vagrant/.rvm/rubies/ruby-1.8.7-p358/lib/ruby/site_ruby/1.8/i686-linux



    ＿人人人人人人人人人＿
    ＞　site_ruby の下　＜
    ￣^Y^Y^Y^Y^Y^Y^Y^￣
</code></pre>

<p>これはダメですねヤバイですねやっちゃダメですね。</p>

<h2>rake-compiler を使う</h2>

<p><a href="https://github.com/luislavena/rake-compiler">rake-compiler</a> というgemを使うと上手いことやってくれるようです。</p>

<h4>gem追加</h4>

<p>Gemfileに以下を追加</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">gem</span> <span class="s1">&#39;rake-compiler&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>んで</p>

<pre><code>$ bundle install
</code></pre>

<h4>タスク追加</h4>

<p>Rakefileに以下を追加</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">if</span> <span class="no">RUBY_PLATFORM</span> <span class="o">=~</span> <span class="sr">/java/</span>
</span><span class='line'>  <span class="nb">require</span> <span class="s1">&#39;rake/javaextensiontask&#39;</span>
</span><span class='line'>  <span class="no">Rake</span><span class="o">::</span><span class="no">JavaExtensionTask</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;GEM_NAME&#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">else</span>
</span><span class='line'>  <span class="nb">require</span> <span class="s1">&#39;rake/extensiontask&#39;</span>
</span><span class='line'>  <span class="no">Rake</span><span class="o">::</span><span class="no">ExtensionTask</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;GEM_NAME&#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h4>rake-compiler流にディレクトリ構成を直す</h4>

<p>ext直下にextconf.rbがある場合は、ext/GEM_NAME/extconf.rb の形になるようにディレクトリ構成を変更します。</p>

<h4>ためしてみる</h4>

<p>rake compile してみる</p>

<pre><code>$ rake compile
mkdir -p tmp/x86_64-linux/jpeg/1.9.3
cd tmp/x86_64-linux/jpeg/1.9.3
/home/masaki/.rvm/rubies/ruby-1.9.3-p194/bin/ruby -I. ../../../../ext/jpeg/extconf.rb
checking for jpeglib.h... yes
checking for main() in -ljpeg... yes
creating Makefile
cd -
cd tmp/x86_64-linux/jpeg/1.9.3
make
compiling ../../../../ext/jpeg/jpeg_jpeg.c
../../../../ext/jpeg/jpeg_jpeg.c: In function ‘jpeg_jpeg_exit’:
../../../../ext/jpeg/jpeg_jpeg.c:32:5: warning: format not a string literal and no format arguments [-Wformat-security]
compiling ../../../../ext/jpeg/jpeg.c
compiling ../../../../ext/jpeg/jpeg_error.c
linking shared-object jpeg.so
cd -
install -c tmp/x86_64-linux/jpeg/1.9.3/jpeg.so lib/jpeg.so
</code></pre>

<p>環境が汚れなさそうなのは確認できましたね。</p>

<p><em>warning直さないと・・・</em></p>

<h4>travisに教える</h4>

<p>.travis.yml に以下を追加 (もちろん前のは消して)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">before_script</span><span class="p-Indicator">:</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">rake compile</span>
</span></code></pre></td></tr></table></div></figure>


<h4>travisのログ確認</h4>

<pre><code>39$ rake compile
40mkdir -p tmp/i686-linux/jpeg/1.8.7
(中略)
54install -c tmp/i686-linux/jpeg/1.8.7/jpeg.so lib/jpeg.so
</code></pre>

<p>環境も汚してないしテストも通りました! やったね!</p>

<h2>参考</h2>

<ul>
<li><a href="https://travis-ci.org/#!/masarakki/jpeg">Travisの実行結果</a></li>
<li><a href="https://github.com/masarakki/jpeg">テスト対象プロジェクト</a></li>
</ul>

</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/05/15/migrate-to-ebook/">ほぼ電子書籍に移行した話</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/04/29/cho-tuning/">超チューニング祭に参加した</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/02/21/oauth-for-non-engineer/">非エンジニアのためのOAuth講座</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/02/16/yamashiro-ga-shinda/">山城が死んだ</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/02/15/how-to-create-gem/">Gemの作り方まとめ 普通のgem編</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/masarakki">@masarakki</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'masarakki',
            count: 6,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>



<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/107002572043873162468?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><hr>
<p>
  Copyright &copy; 2014 - masarakki -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
